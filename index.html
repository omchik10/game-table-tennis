<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<title>בתים ונוקאוט רשמי</title>
<style>
body { font-family: Tahoma, Arial, sans-serif; background:#f9f9f9; margin:0; padding:0; }
h1, h2 { text-align:center; color:#002b7f; margin-top:30px; }
h1 { font-size:28px; }
.tab { overflow:hidden; border-bottom:1px solid #ccc; margin-top:20px; }
.tab button { background:#eee; float:right; border:none; outline:none; cursor:pointer; padding:10px 16px; transition:0.3s; font-size:16px; }
.tab button:hover { background:#ddd; }
.tab button.active { background:#ccc; }
.tabcontent { display:none; padding:10px 0; }
table { border-collapse:collapse; width:100%; max-width:900px; margin:20px auto; background:white; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
th, td { border:1px solid #000; padding:10px; text-align:center; }
tr:nth-child(even) td { background:#f2f2f2; }
input[type="text"], input[type="number"] { padding:8px; margin:4px; border:1px solid #aaa; border-radius:6px; text-align:center; width:60px; }
button { margin:10px 5px; padding:8px 16px; font-size:14px; cursor:pointer; background:#002b7f; color:white; border:none; border-radius:6px; transition:0.3s; }
button:hover { background:#0040bf; }
.hidden { display:none; }
#playerCountSection, #groupsSection, #knockoutSection { display:flex; flex-direction:column; align-items:center; margin-top:30px; }

.bracket { display:flex; justify-content:center; flex-wrap:wrap; gap:20px; margin:20px auto; }
.round { display:flex; flex-direction:column; gap:15px; }
.match { background:#fff; border:1px solid #000; padding:10px; text-align:center; min-width:120px; border-radius:6px; }
@media (max-width:600px) {
  .bracket { flex-direction:column; align-items:center; }
  .round { flex-direction:row; overflow-x:auto; gap:10px; }
}
</style>
</head>
<body>
<h1>בתים ונוקאוט רשמי</h1>

<div id="playerCountSection">
  <label>כמה בתים (4, 8, 16):</label>
  <select id="groupCount">
    <option value="4">4</option>
    <option value="8">8</option>
    <option value="16">16</option>
  </select>
  <button id="create-groups">צור בתים</button>
</div>

<div id="groupsSection" class="hidden"></div>
<div id="knockoutSection" class="hidden"></div>

<script>
let groups = [];
let groupCount = 0;
let knockoutPlayers = [];

document.getElementById("create-groups").addEventListener("click", createGroups);

function createGroups() {
  const sel = document.getElementById("groupCount");
  groupCount = parseInt(sel.value,10);
  groups = [];
  for(let g=0; g<groupCount; g++) groups.push([]);
  renderGroups();
}

function renderGroups() {
  const container = document.getElementById("groupsSection");
  container.innerHTML = '';
  const tabDiv = document.createElement("div");
  tabDiv.className='tab';
  for(let g=0; g<groupCount; g++){
    const btn = document.createElement("button");
    btn.textContent = `בית ${g+1}`;
    btn.onclick = ()=>openTab(g);
    if(g===0) btn.className='active';
    tabDiv.appendChild(btn);
  }
  const knockoutBtn = document.createElement("button");
  knockoutBtn.textContent="עץ נוקאוט";
  knockoutBtn.onclick = ()=>openKnockoutTab();
  tabDiv.appendChild(knockoutBtn);
  container.appendChild(tabDiv);

  for(let g=0; g<groupCount; g++){
    const div = document.createElement("div");
    div.id=`group${g}`;
    div.className='tabcontent';
    if(g===0) div.style.display='block';
    div.innerHTML = `
      <label>כמה שחקנים בבית (3–20):</label>
      <input type="number" min="3" max="20" id="playerCount${g}">
      <button id="setupBtn${g}">צור שחקנים</button>
      <div id="playersInputs${g}"></div>
      <div id="preRanking${g}"></div>
      <div id="matches${g}"></div>
      <div id="ranking${g}"></div>
    `;
    container.appendChild(div);
    document.getElementById(`setupBtn${g}`).addEventListener("click", ()=>setupPlayers(g));
  }
  container.classList.remove("hidden");
}

function openTab(index){
  const tabcontent = document.getElementsByClassName("tabcontent");
  for(let i=0;i<tabcontent.length;i++){ tabcontent[i].style.display='none'; }
  if(index<groupCount) tabcontent[index].style.display='block';
  const tabbuttons = document.querySelectorAll(".tab button");
  tabbuttons.forEach(b=>b.classList.remove("active"));
  tabbuttons[index].classList.add("active");
  document.getElementById("knockoutSection").style.display='none';
}

function openKnockoutTab(){
  const tabcontent = document.getElementsByClassName("tabcontent");
  for(let i=0;i<tabcontent.length;i++){ tabcontent[i].style.display='none'; }
  document.getElementById("knockoutSection").style.display='block';
  const tabbuttons = document.querySelectorAll(".tab button");
  tabbuttons.forEach(b=>b.classList.remove("active"));
  tabbuttons[tabbuttons.length-1].classList.add("active");
}

function setupPlayers(gIndex){
  const n = parseInt(document.getElementById(`playerCount${gIndex}`).value,10);
  if(isNaN(n)||n<3||n>20) { alert("יש להזין מספר בין 3 ל-20"); return; }
  const div = document.getElementById(`playersInputs${gIndex}`);
  div.innerHTML='';
  groups[gIndex]=Array(n).fill('').map(()=>{ return {name:'', points:0, wins:0}; });

  for(let i=0;i<n;i++){
    const input = document.createElement("input");
    input.type='text';
    input.placeholder=`שם שחקן ${i+1}`;
    input.onchange=(e)=>{ groups[gIndex][i].name=e.target.value; updatePreRanking(gIndex); };
    input.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault();
        const inputs = Array.from(div.querySelectorAll("input[type=text]"));
        const idx = inputs.indexOf(e.target);
        if(idx+1<inputs.length) inputs[idx+1].focus();
      }
    });
    div.appendChild(input);
    div.appendChild(document.createElement("br"));
  }

  const btn = document.createElement("button");
  btn.textContent='צור משחקים';
  btn.onclick=()=>createMatches(gIndex);
  div.appendChild(btn);

  updatePreRanking(gIndex);
}

function updatePreRanking(gIndex){
  const players = groups[gIndex];
  let rankingHTML=`<h3>דירוג מקדימה בית ${gIndex+1}</h3><table><thead><tr><th>מקום</th><th>שחקן</th></tr></thead><tbody>`;
  players.forEach((p,i)=>{ rankingHTML+=`<tr><td>${i+1}</td><td>${p.name}</td></tr>`; });
  rankingHTML+='</tbody></table>';
  document.getElementById(`preRanking${gIndex}`).innerHTML = rankingHTML;
}

function createMatches(gIndex){
  const players = groups[gIndex];
  const n = players.length;
  const matchesDiv = document.getElementById(`matches${gIndex}`);
  matchesDiv.innerHTML='<h3>משחקים לפי סדר ITTF</h3><table id="matchesTable"><thead><tr><th>משחק</th><th>שחקן 1</th><th>שחקן 2</th><th>תוצאה</th></tr></thead><tbody></tbody></table>';
  const tbody = matchesDiv.querySelector("tbody");

  let matchOrder = [];
  if(n===4){
    matchOrder = [[0,3],[1,2],[0,2],[1,3],[0,1],[2,3]];
  } else {
    for(let i=0;i<n;i++){
      for(let j=i+1;j<n;j++) matchOrder.push([i,j]);
    }
  }

  matchOrder.forEach((pair, index)=>{
    const i = pair[0], j = pair[1];
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${index+1}</td><td>${players[i].name}</td><td>${players[j].name}</td>
      <td>
        <input type="number" placeholder="שחקן1" style="width:60px">
        <input type="number" placeholder="שחקן2" style="width:60px">
      </td>`;
    const inputs = tr.querySelectorAll("input");
    inputs.forEach((inp,k)=>inp.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault();
        if(k+1<inputs.length) inputs[k+1].focus();
        else { const nextRow = tr.nextElementSibling; if(nextRow) nextRow.querySelectorAll("input")[0].focus(); }
      }
    }));
    tbody.appendChild(tr);
  });

  const btn = document.createElement("button");
  btn.textContent='חשב דירוג סופי';
  btn.onclick=()=>calculateResults(gIndex);
  matchesDiv.appendChild(btn);
}

function calculateResults(gIndex){
  const matchesDiv = document.getElementById(`matches${gIndex}`);
  const tbody = matchesDiv.querySelector("tbody");
  const players = groups[gIndex];
  players.forEach(p=>{p.points=0;p.wins=0;});
  const rows = Array.from(tbody.querySelectorAll("tr"));
  for(let row of rows){
    const tds = row.querySelectorAll("td");
    const idx1 = players.findIndex(p=>p.name===tds[1].textContent);
    const idx2 = players.findIndex(p=>p.name===tds[2].textContent);
    const score1 = parseInt(tds[3].querySelectorAll("input")[0].value,10);
    const score2 = parseInt(tds[3].querySelectorAll("input")[1].value,10);
    if(isNaN(score1)||isNaN(score2)||score1===score2){ alert("חייב להיות מנצח בכל משחק"); return; }
    if(score1>score2){ players[idx1].wins++; players[idx1].points+=score1; players[idx2].points+=score2;}
    else{ players[idx2].wins++; players[idx2].points+=score2; players[idx1].points+=score1;}
  }
  players.sort((a,b)=>b.wins-a.wins || b.points-a.points);
  let rankingHTML=`<h3>דירוג סופי בית ${gIndex+1}</h3><table><thead><tr><th>מקום</th><th>שחקן</th><th>ניצחונות</th><th>נקודות</th></tr></thead><tbody>`;
  players.forEach((p,i)=>{ rankingHTML+=`<tr><td>${i+1}</td><td>${p.name}</td><td>${p.wins}</td><td>${p.points}</td></tr>`; });
  rankingHTML+='</tbody></table>';
  document.getElementById(`ranking${gIndex}`).innerHTML = rankingHTML;
  setupKnockout();
}

function setupKnockout(){
  knockoutPlayers=[];
  if(groupCount<2) return;
  let firsts = groups.map(g => g[0]);
  let seconds = groups.map(g => g[1]);
  for(let i=0;i<groupCount;i+=2){
    if(firsts[i] && seconds[i+1]) knockoutPlayers.push({p1:firsts[i],p2:seconds[i+1]});
    if(firsts[i+1] && seconds[i]) knockoutPlayers.push({p1:firsts[i+1],p2:seconds[i]});
  }
  renderBracket(knockoutPlayers);
}

function renderBracket(initialMatches){
  const container = document.getElementById("knockoutSection");
  container.innerHTML='<h2>עץ נוקאוט רשמי</h2><div class="bracket" id="bracket"></div>';
  const bracketDiv = document.getElementById("bracket");
  let rounds = [initialMatches];

  function renderRound(matches){
    const roundDiv = document.createElement("div");
    roundDiv.className="round";
    matches.forEach((match)=>{
      const matchDiv = document.createElement("div");
      matchDiv.className="match";
      matchDiv.innerHTML = `<div>${match.p1.name}</div><div>${match.p2.name}</div>
        <div>
          <input type="number" placeholder="שחקן1" style="width:50px">
          <input type="number" placeholder="שחקן2" style="width:50px">
        </div>`;
      const inputs = matchDiv.querySelectorAll("input");
      inputs.forEach(inp=>inp.addEventListener("input", ()=>{
        const s1 = parseInt(inputs[0].value,10);
        const s2 = parseInt(inputs[1].value,10);
        if(isNaN(s1)||isNaN(s2)||s1===s2) return;
        const winner = s1>s2 ? match.p1 : match.p2;
        matchDiv.style.background="#d1ffd1";
        inputs.forEach(i=>i.disabled=true);
        match.winner = winner;
        checkNextRound();
      }));
      roundDiv.appendChild(matchDiv);
    });
    bracketDiv.appendChild(roundDiv);
  }

  function checkNextRound(){
    const lastRound = rounds[rounds.length-1];
    if(lastRound.every(m=>m.winner)){
      if(lastRound.length===1){
        const finalMatchDiv = bracketDiv.querySelector(".round:last-child .match");
        finalMatchDiv.innerHTML += `<div style="margin-top:10px; font-weight:bold;">מנצח סופי: ${lastRound[0].winner.name}</div>`;
      } else {
        const nextMatches = [];
        for(let i=0;i<lastRound.length;i+=2){
          nextMatches.push({p1:lastRound[i].winner, p2:lastRound[i+1].winner});
        }
        rounds.push(nextMatches);
        renderRound(nextMatches);
      }
    }
  }

  renderRound(initialMatches);
}
</script>
</body>
</html>
